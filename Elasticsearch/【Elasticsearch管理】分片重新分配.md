# Cluster Reroute

## 分片重分配

 reroute命令允许手动更改集群中各个分片的分配。例如，可以显式地将分片从一个节点移动到另一个节点，可以取消分配，还可以显式地将未分配的分片分配到特定的节点。

```
POST /_cluster/reroute
{
    "commands" : [
        {
            "move" : {
                "index" : "test", "shard" : 0,
                "from_node" : "node1", "to_node" : "node2"
            }
        },
        {
          "allocate_replica" : {
                "index" : "test", "shard" : 1,
                "node" : "node3"
          }
        }
    ]
}
```

需要注意的是，在处理了任何重分配命令之后，Elasticsearch将正常执行再平衡(注意设置的值，如`cluster.routing.rebalance.enable`)，以保持平衡状态。

例如，如果请求的分配包括将一个分片从node1移动到node2，那么这可能会导致将一个分片从node2移动回node1，以达到平衡。

可以使用`cluster.routing.allocation.enable`将集群设置为禁用分配。如果禁用了分配，那么将执行的唯一分配是使用reroute命令给出的显式分配，以及由于重新平衡而导致的后续分配。

通过使用`?dry_run` 查询参数，或者通过在请求主体中传递`dry_run:true`，可以在“dry run”模式下运行重新路由命令。这将计算将命令应用到当前集群状态的结果，并在应用命令(和重新平衡)后返回生成的集群状态，但不会实际执行请求的更改。

如果包含`?explain` 查询参数，那么响应中将包含关于为什么可以或不可以执行命令的详细说明。



## commond支持的命令

move

将已启动的分片从一个节点移动到另一个节点。对于要移动分片的节点，接受索引和分片号;对于要移动分片的节点，接受from_node;对于要移动分片的节点，接受to_node。

canel

取消分片的分配(或恢复)。接受索引和分片作为索引名和分片号，接受节点作为取消分片分配的节点。通过取消现有副本并允许通过标准恢复过程重新初始化，可以强制从主分片重新同步现有副本。默认情况下，只能取消副本分片分配。如果有必要取消主分片的分配，那么allow_primary标志也必须包含在请求中。

allocate_replica  

 将未分配的复制分片分配给节点。接受索引和分片作为索引名和分片号，并接受分配分片的节点。将分配决定者考虑在内。

 

## 失败分配重试

在放弃并保留未分配的分片之前，集群将尝试连续分配一个分片最大`index.allocation.max_retries`次（默认为5）。 这种情况可能是由于结构问题引起的，例如，有一个分析器引用了并非在所有节点上都存在的停用词文件。

一旦问题得到纠正，可以通过使用`?retry_failed` URI查询参数调用reroute命令手动重试分配，该参数将尝试对这些分片进行一次重试。



## 强制分配不可恢复的错误

还有两个命令允许将主分片分配到节点。但是，使用这些命令时应该非常小心，因为主分片分配通常是由Elasticsearch完全自动处理的。主分片不能被自动分配的原因包括:

- 创建了一个新的索引，但是没有满足分配条件的节点。
- 在集群中的当前数据节点上找不到数据的最新分片副本。为了防止数据丢失，系统不会自动将陈旧的分片副本提升到为主分片。

以下两个命令是危险的，可能会导致数据丢失。它们用于原始数据无法恢复且集群管理员接受丢失的情况。如果遇到可以修复的临时问题，请参阅上面描述的retry_failed标志。

> 强调:如果执行了这些命令，然后一个节点加入了包含受影响分片副本的集群，那么新加入节点上的副本将被删除或覆盖。



allocate_stale_primary

将主分片分配给持有陈旧副本的节点。 接受索引名称和分片号的索引和分片，以及将分片分配到的节点。 使用此命令可能会导致提供的分片ID的数据丢失。 如果具有良好数据副本的节点稍后重新加入群集，则该数据将被删除或用此命令强制分配的过时副本的数据覆盖。 为确保充分理解这些含义，此命令要求将标志accept_data_loss显式设置为true。

allocate_empty_primary

将空的主分片分配给节点。 接受索引名称和分片号的索引和分片，以及将分片分配到的节点。 如果此命令先前已启动，则使用此命令将导致完全丢失索引到该分片中的所有数据。 如果具有数据副本的节点稍后重新加入群集，则该数据将被删除。 为确保充分理解这些含义，此命令要求将标志accept_data_loss显式设置为true。